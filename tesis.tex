\documentclass[12pt,a4paper]{article}
\usepackage[spanish,es-tabla]{babel} % espanol
\usepackage[utf8]{inputenc} % acentos sin codigo
\usepackage[left=3.5cm,right=2cm,top=2.5cm,bottom=2cm,includehead,includefoot]{geometry}  %margenes segun pauta de la U
\usepackage{setspace}
\onehalfspacing %interlineado 1.5
\usepackage{graphicx}
\usepackage[usenames]{color}
\usepackage{amsfonts}
\usepackage{algpseudocode}
\usepackage{amsmath}
\usepackage{booktabs} %Rules en las tablas
\usepackage{listings}
\usepackage{xcolor}
\usepackage{afterpage}
\usepackage{float}
\usepackage{subcaption}
\usepackage{multirow}
\usepackage{tcolorbox}
\usepackage{verbatim} %Comentarios con \begin end comment
\usepackage{csquotes}
\usepackage{datetime} %Para obtener formato a la fecha
\usepackage[backend=biber,style=alphabetic]{biblatex}%packages Bibliografia
\addbibresource{biblio.bib}%se carga el archivo
\usepackage{times} %font times new roman (?)
\usepackage{hyperref}
\hypersetup{
	colorlinks=false, %set true if you want colored links
	linktoc=all,     %set to all if you want both sections and subsections linked
	linkcolor=blue,  %choose some color if you want links to stand out
	pdfborder={0 0 0},
}


\newcommand{\grad}{$^{\circ}$}

\newcommand{\nombreTesis}{\textsc{sistema de evaluación y bio-feedback para Balance postural}}

\newcommand{\nombreDispositivo}{Dispositivo de BioFeed-Back }

\newdateformat{fecha}{%Método para obtener el mes y el año
	\monthname[\THEMONTH] \THEYEAR}

\DeclareLabelalphaTemplate{
	\labelelement{
		\field[uppercase,final]{shorthand}
		\field[uppercase]{label}
		\field[uppercase,strwidth=3,strside=left,ifnames=1]{labelname}
		\field[uppercase,strwidth=1,strside=left]{labelname}
	}
	\labelelement{
		\field{year}
	}
}

\DeclareCaptionLabelFormat{andtable}{#1~#2  \&  \tablename~\thetable}

\pagestyle{headings}

\begin{document}

\thispagestyle{empty}
\vspace*{-2cm}
\hspace{-3cm}
\hbox{\vsize = 5cm
\vbox{\hsize = 11cm
\begin{flushleft}
	{\small{\bf UNIVERSIDAD CAT\'OLICA DEL MAULE}\\
		Facultad de Ciencias de la Ingenier\'ia\\
		Escuela de Ingenier\'ia Civil Inform\'atica}
\end{flushleft}}

\vbox{\hsize = 7cm
	\begin{flushright}
		{\small{\bf PROFESOR GU\'IA}\\
			Mary Carmen Jarur\\
			\hspace{1cm}}
	\end{flushright}}
}
\vspace{5.5cm}

\begin{center}
	{\Large {\bf \nombreTesis}}
	
	\
	
	\
	
	\small {\bf H\'ECTOR GABRIEL PEREDO URBINA}\\
	
	
	\
	
	\
	
	\textmd{Tesis para optar al\\ T\'itulo Profesional de Ingeniero Civil Inform\'atico}
	
	\vspace{4cm}
	\vfill{{\large {\sc Talca, \fecha\today }}}
	
\end{center} 

\pagebreak

%%%%%%%%%%%%%%%%%%%%% FIN  PORTADA     %%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%% PORTADA COMISION    %%%%%%%%%%%%%%%%%%%%%%%%

\thispagestyle{empty}

\begin{center}
	{\small {\bf UNIVERSIDAD CATÓLICA DEL MAULE}}\\
	\small {\bf FACULTAD DE CIENCIAS DE LA INGENIERÍA}\\
	\small {\bf ESCUELA DE INGENIERÍA CIVIL INFORMÁTICA}
	
\end{center}
\vspace{1cm}

\begin{center}
	{\small {\bf TESIS PARA OPTAR AL}}\\
	\small {\bf AL TÍTULO PROFESIONAL DE INGENIERO CIVIL INFORMÁTICO}\\
\end{center}

\vspace{1cm}

\begin{center}
	\bf{ \nombreTesis}
	
	\
	
	\small {\bf  HECTOR GABRIEL PEREDO URBINA}\\
	
\end{center}

\vspace{1cm}

\begin{tabular}{l@{\hspace{1cm}}c@{\hspace{3cm}}l@{\hspace{1cm}}l}
	{\bf COMISI\'ON EXAMINADORA}&&{\bf FIRMA}&\\
	&&&\\
	PROFESOR GUÍA &&&\\
	MARY CARMEN JARUR MUÑOZ&&&\\
	\cline{2-3}
	&&&\\
	
	PROFESOR COMISI\'ON&&& \\
	DR. HERN\'AN MAUREIRA PAREJA&&&\\
	\cline{2-3}
	&&&\\
	
	PROFESOR COMISI\'ON&&& \\
	DR. MARCO ANTONIO MORA COFRE&&&\\
	\cline{2-3}
	&&&\\
	
	&&&\\
	NOTA FINAL EXAMEN DE T\'ITULO &&& \\
	\cline{2-3}
\end{tabular}
\vspace{.7cm}


\begin{center}
	\vfill{{\large {\sc Talca, \fecha\today }}}
\end{center}


\pagebreak

%%%%%%%%%%%%%%%%%%%%% FIN  PORTADA COMISION   %%%%%%%%%%%%%%%%%%%%%%

\thispagestyle{empty}
\tableofcontents %Indice de Contenidos
\thispagestyle{empty}
\listoffigures
\thispagestyle{empty}
\newpage
\listoftables

\thispagestyle{empty}
\pagebreak
\setcounter{page}{1}

\let\stdsection\section
\renewcommand\section{\newpage\stdsection}



\section{Introducción}
La comprensión de las dinámicas y patrones de movimiento humano, se facilitan enormemente con el apoyo de tecnologías adecuadas, que permitan medir, registrar y analizar variables cinemáticas. Particularmente, el estudio del movimiento humano (Kinesiología) depende hoy en día de las facilidades tecnológicas que ofrece la electrónica (sensores, microcontroladores, sistema de adquisición de señales) y las ciencias de la computación (procesamiento, análisis y posterior reporte adecuado de  variables cinemáticas y cinéticas).  

Las soluciones tecnológicas que hoy existen, no solo permiten realizar el seguimiento (‘tracking’) y representación gráfica, sino que además facilitan la representación en tiempo real de las variables de interés, conformando con esto los denominados sistemas de Bio-feedback (retroalimentación de señales biológicas). Aunque existen alternativas adecuadas para estos fines, poseen el inconveniente en lo prohibitivo de su valor comercial, junto con ser soluciones cerradas tanto en hardware como software, lo que limita las funciones según las características propuestas por fabricante, hace prácticamente imposible la adición de nuevas funcionalidades y obtención de la información capturada por los sensores (datos crudos).

Frente a este desafío, está la posibilidad de integrar tecnología para conseguir soluciones de menores costos, que permitan realizar investigación y al mismo tiempo explorar posibilidades de innovación tecnológica que den paso al desarrollo de tecnología generadora de impacto no tan sólo en el ámbito de la investigación sino que también en la salud.

Particularmente, este proyecto propone desarrollar un sistema de integración hardware-software que permita el registro del comportamiento pendular de la posición bípeda quieta (variables de posición y velocidad angular en el tiempo), habilitando funciones de bio-feedback que permitan replicar evaluaciones de balance postural.

\subsection{Objetivos Generales}
Diseñar e implementar un prototipo de software-hardware basado en un microcontrolador Arduino y un sensor de velocidad angular y acelerometría de 3 ejes, para el registro y representación gráfica del centro de masa y bio-realimentación.

\subsection{Objetivos Específicos}
\begin{itemize}
	\item Integrar microcontrolador Arduino con sensor (giroscopio-acelerómetro).
	\item Diseñar sistema que permita el registro y visualización de todas las variables cinemáticas (posición y velocidad angular) del centro de masa. 
	\item Construcción de un sistema que facilite mediante bio-realimentación la posición del centro de presión (proyección del centro de masa).
\end{itemize}	

\subsection{Contribución Esperada}

El desarrollo del sistema permitirá medir y registrar el comportamiento del centro de masa y su respectiva proyección (centro de presión) durante la posición bípeda quieta, al mismo tiempo que realimentará la señal como mecanismo de evaluación de balance postural e implementación de biofeedback.

El principal alcance de la propuesta es la posibilidad de contar con una solución abierta, que facilita la importación de todos los registros además del procesamiento de las señales recogidas de las evaluaciones, permitiendo además integrar la solución a otros sistemas.

El costo del sistema, respecto a las soluciones de mercado (Biodex- Balance SD), es bajo, lo que le da viabilidad económica al proyecto, permitiendo además dejar el prototipo en operación en el Laboratorio de Biomecánica. 

Desde el punto de vista disciplinar (Ciencias de la Ingeniería), este proyecto materializa trabajos de investigación y colaboración transdisciplinario entre la Facultad de Ingeniería y la Facultad de Salud de la UCM. Además posiciona a los Ingenieros Informáticos como profesionales capaces de adecuarse a diferentes contextos mediante soluciones tecnológicas.

\subsection{Organizaci\'on de la Tesis}
La organización del documento comienza con describir la situación actual del estudio de los principales avances en el desarrollo de soluciones para el estudio del Balance. Seguidamente son descritos cada uno de los elementos técnicos relacionados para dar solución al problema, es decir,  protocolos, sensores, algoritmos, etc. y como estos fueron implementados.

Finalmente son expuestos los resultados, junto con las conclusiones más relevantes, ademas de presentar trabajos futuros con el objetivo para mejorar aún más la propuesta.


\section{Estado del Arte}

\subsection{Contexto de la problemática}
Más de un tercio de la población mayor de 65 años presenta algunos problemas con el balance o deambulación. Los pacientes con trastornos neurológicos o musculo-esqueléticos son aún más propensos a tener problemas de equilibrio que afectan a su movilidad. La complejidad del control del equilibrio es resultado  de muchos tipos de problemas diferentes con evaluaciones clínicas sistemática específicas para prescribir un tratamiento eficaz.
El control del equilibrio es complejo e implica el mantenimiento de posturas \cite{mancini_relevance_2010}, mantener el movimiento y recuperar el equilibrio. El control de balance consiste en controlar el centro de masa del cuerpo entre los límites de estabilidad. Las evaluaciones clínicas del equilibrio pueden ayudar a evaluar el riesgo de caídas y/o determinar las causas de los trastornos del equilibrio subyacente.

La mayoría de las escalas de valoración del equilibrio funcional evalúan el riesgo de caída y la necesidad de rehabilitación, pero no es diferenciado cada uno de los tipos de déficits del balance. Un enfoque de sistema para la evaluación clínica puede diferenciar diferentes tipos de trastornos del equilibrio y un enfoque fisiológico puede determinar los mecanismos subyacentes sensoriomotoras asociados al trastorno del equilibrio. Las medidas objetivas de equilibrio valiéndose de medios informáticos y sensores inercialess pueden traer más precisión, exactitud y sensibilidad que las pruebas de equilibrio clínicas\cite{chaudhry_measurement_2011}.

\subsection{Estudio del Balance usando Sensores}
Recientemente, los sensores de movimiento ``weareables'' se han desarrollado para la robótica, industria aeroespacial y en las mediciones biomédicas se han utilizado para medir el control del balance\cite{mancini_relevance_2010}. Estos sensores, con transferencia inalámbrica de datos , tienen el potencial de superar los principales inconvenientes de coste, tamaño y ubicación limitado de las pruebas computarizadas , así como permitir la medición objetiva de la oscilación postural y movimientos durante la ejecución de tareas.

Los acelerómetros y/o giroscopios han sido exitosamente utilizados \cite{mancini_relevance_2010} para el seguimiento de movimiento,  detección de caídas, y para la medición de control del balance. En el ámbito de dispositivos ``Weareables" se han usado para medir los movimientos tanto de pierna, brazo y torso.


\subsection{Equipamientos para estudio del balance} Algunos de los principales instrumentos utilizados para el estudio del Balance son:


\subsubsection{Plataforma de Fuerza Kistler} Es un Gold Standard  en lo referente a estabilometría\cite{donath_testing_2012}, es una plataforma de fuerza de dimensiones
	0,4m por 0,6m que consta de cuatro 	transductores piezoeléctricos, situados en las esquinas. Estos transductores son capaces de medir las fuerzas de reacción del suelo en los planos verticales medio-lateral (x), antero-posterior (y) ver Figura (\ref{fig:KistlerFP}).

\begin{figure}[H]
	\centering
	\includegraphics[width=0.5\linewidth]{images/KistlerFP}
	\caption{Plataforma de Fuerza Kistler}
	\label{fig:KistlerFP}
\end{figure}


\subsubsection{Balance SD} Un instrumento desarrollado por Biodex \cite{Biodex} utilizado para la medicina física, especialmente para cualquiera que desee mejorar su equilibrio, aumentar la agilidad, desarrollar el tono muscular y tratar una amplia variedad de patologías asociadas a la perdida de balance.
Es un equipo que cuenta con biofeed-back principalmente visual, pero en nuevas versiones incluye soporte para biofeed-back vibratorio.

\begin{figure}[H]
	\centering
	\includegraphics[width=0.25\linewidth]{images/BalanceSD}
	\caption{Sistema Balance SD}
	\label{fig:balanceSD}
\end{figure}


\section{Marco Teórico}

\subsection{Introducción}
El marco teórico, que se desarrolla a continuación, permite conocer los conceptos básicos para el entendimiento del desarrollo de este proyecto de Tesis.
Partiendo por la definición de los estándares aplicados en los estudios del Balance, junto con definición de términos que comúnmente serán utilizados.


Luego la descripción de los elementos de hardware utilizados, características de sensores, protocolos de comunicación y microcontrolador.

Finalmente se describe el marco de trabajo para el desarrollo del software.

Con este marco teórico se podrá comprender el desarrollo que se detalla mas adelante.


\subsection{Estudio y evaluación de Balance}

En el estudio del balance postural, los registros representados por los sensores, generalmente se desagregan en el plano Frontal y Sagital denominándolos Antero-Posterior y Medio-Lateral respectivamente. 

\subsubsection{Sistemas Coordenados}

Toda la información obtenida debe estar asociado según un sistema específico de coordenadas, que sirva de referencia para la interpretación y comprensión de la información.

\begin{itemize}
	
	\item \textbf{Planos anatómicos} 
	\subitem \textbf{Plano Sagital:}
	Se toma de referencia el cuerpo humano trazando línea una  vertical de referencia que teóricamente cruza el cuerpo por la parte media y central, a modo de plomada imaginaria, esta línea ayuda en la distinción de miembros o elementos en el «lado izquierdo» o «lado derecho».
	\subitem \textbf{Plano Frontal:} Forma un ángulo recto con los planos sagitales. En un ser humano, el plano medio coronal divide el cuerpo en posición de pie en dos mitades (frontal y dorsal, o anterior y posterior) mediante una línea imaginaria que corta ambos hombros.
	
	\begin{figure}[H]
		\centering
		\includegraphics[width=0.5\textwidth]{images/planosAnatomicos}
		\caption{Planos Anatómicos}
		\label{fig:sagital}
	\end{figure}
	
	\item \textbf{Ejes del sensor:} Los ejes contenidos en el sensor son expresados en coordenadas X, Y, Z.
	Según la orientación del sensor cualquiera de sus ejes puede ser paralelo a la gravedad de la tierra, que apunta en sentido positivo hacia el centro de esta.
\end{itemize}


\subsubsection{Cálculo del Centro de Presión (COP)}
El COP en las plataformas de fuerza en general es el promedio de las fuerzas aplicadas en cada uno de los sensores piezoeléctricos (sensores de presión/fuerza) tal como lo demuestra la Figura (\ref{fig:calculoCOP}).

\begin{figure}[H]
	\centering
	\includegraphics[width=0.65\linewidth]{images/calculoCOP}
	\caption{Cálculo COP Plataforma de Fuerza}
	\label{fig:calculoCOP}
\end{figure}

\subsubsection{Estabilometría}
Corresponde al estudio del Centro de Presión (COP) para determinar deficiencias posturales que perjudican el Balance.

Existen estándares respecto a las características necesarias para la medición del COP \cite{scoppa_clinical_2013}.

Varias declaraciones sobre la cuestión sigue siendo objeto de debate de la normalización estabilometría fueron acordados por el ISPGR (International Society for Posture and Gait Research).
Se definió un conjunto de características metrológicas para las plataformas estabilométricas.
Basándose tanto en la práctica y verificación experimental se acordó que, para obtener una apropiada precisión y sensibilidad:
\begin{itemize}
	\item El intervalo de adquisición no debe ser inferior a 25s.
	\item La frecuencia de muestreo debe ser de al menos 50 Hz (fs=100Hz óptima).
	\item Estándares Técnicos Tabla (\ref{table:mediciones}):
	\begin{table}[H]
		\centering
		
		\begin{tabular}{|c|c|}			
			\hline \textbf{Variable} & \textbf{Valor} 	\\ 
			\hline Exactitud 	& $>$ 0.1 mm 		\\ 
			\hline Presición 	& $>$ 0.05 mm 		\\ 
			\hline Resolución 	& $>$ 0.05 mm 		\\ 
			\hline Ancho Frecuencia & 0.01–10 Hz	\\ 
			\hline 			
		\end{tabular}
		\caption{Estándares Técnicos Mediciones}
		\label{table:mediciones}
	\end{table}	  
\end{itemize}



\newpage
\subsection{Microcontroladores Arduino}
Arduino\cite{ARDUINO} es una plataforma de hardware de código abierto, basada en una sencilla placa con entradas y salidas, analógicas y digitales, con un entorno de desarrollo basado en el lenguaje de programación C++, donde sus principales características son:
\begin{itemize}
	\item \textbf{Bajo Coste:} Las placas Arduino son relativamente de bajo coste comparadas con otras plataformas microcontroladoras Handy Board, Basic Stamp\textregistered. La versión menos cara del módulo Arduino puede ser ensamblada a mano, e incluso los módulos de Arduino preensamblados cuestan menos de 50\$.
	\item \textbf{Multiplataforma:} El software de Arduino se ejecuta en sistemas operativos Windows, Macintosh OSX y GNU/Linux. La mayoría de los sistemas microcontroladores están limitados a Windows.
	\item \textbf{Entorno de programación simple y claro:} El entorno de programación de Arduino es fácil de usar para principiantes, pero suficientemente flexible para que usuarios avanzados puedan aprovecharlo también. Para profesores, está convenientemente basado en el entorno de programación Processing, de manera que estudiantes aprendiendo a programar en ese entorno estarán familiarizados con el aspecto y la imagen de Arduino.
	\item \textbf{Código abierto y software extensible:} El software Arduino está publicado como herramientas de código abierto, disponible para extensión por programadores experimentados. El lenguaje puede ser expandido mediante librerías C++, y la gente que quiera entender los detalles técnicos pueden hacer el salto desde Arduino a la programación en lenguaje AVR C en el cual está basado. De forma similar, puedes añadir código AVR-C directamente en tus programas Arduino si quieres.
	\item \textbf{Código abierto y hardware extensible:} El Arduino está basado en microcontroladores ATMEGA8 y ATMEGA168 de Atmel. Los planos para los módulos están publicados bajo licencia Creative Commons, por lo que diseñadores experimentados de circuitos pueden hacer su propia versión del módulo, extendiéndolo y mejorándolo. Incluso usuarios relativamente inexpertos pueden construir la versión de la placa del módulo para entender cómo funciona y ahorrar dinero.
	
\end{itemize}

\newpage
\subsection{Sistema microelectromecánico (MPU6050)}
El sistema Microelectromecánico (MEMS) MPU6050\cite{MPU6050}, es un dispositivo capaz de medir la velocidad angular y fuerza de gravedad gracias a estar compuesto por Giroscópico y Acelerómetro ambos de 3 ejes, el hecho de poseer estos 2 sensores de movimiento indica que existen al menos 6 grados de libertad para utilizar al momento de obtener las mediciones provenientes de éste.

La tecnología utilizada MEMS patentada por InverSense, en el caso del giroscopio consiste en masas vibratorias verticalmente alineadas las cuales son usadas para crear un chip de bajo costo.

El MPU6050 está diseñado para realizar seguimiento (Tracking) gracias a que posee un bajo consumo, es de bajo costo, y cumple con los requisitos de los teléfonos inteligentes, tabletas y sensores portátiles \cite{MPU6050}.
La transmisión de datos con el microcontrolador es realizada únicamente mediante el protocolo I2C, el cual requiere de 2 líneas de conexión una para el envío de datos (SDA) y otra para el clock (SCL), las cuales varían dependiendo del modelo de microcontrolador, junto con la alimentación que consiste en la línea de voltaje (VCC) y conexión a tierra (GND).

El acelerómetro incluido mide el movimiento lineal respecto a cada uno de sus tres ejes ver Figura (\ref{fig:MPU6050}), es decir la aceleración percibida por el movimiento y esta es expresada en proporción a la fuerza de gravedad (veces de g).

El giroscopio mide la rotación alrededor de cada uno de los ejes ver Figura (\ref{fig:MPU6050}), es decir la velocidad angular expresada en \grad/seg.

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.5]{images/MPU6050}
	\caption{Diagrama MPU6050}
	\label{fig:MPU6050}
\end{figure}

\newpage
\subsubsection{Características Técnicas}

\begin{itemize}
	
	\item \textbf{Rango:} Poseen un rango configurable ambos sensores incluidos, tanto acelerómetro como giroscopio, el rango nos indica el dominio sobre el cual son adquiridos los datos, más concretamente los valores máximos y mínimos donde fluctúan la información obtenida.
	
	\item \textbf{Sensibilidad:} La sensibilidad describe la mínima variación medible, es decir la razón de cambio entre una variable entrante y el resultado de la variable saliente (ver Tabla (\ref{table:caracteristicasSensor})).
	
	\begin{table}[H]
		\centering
		\begin{tabular}{|c|c|c|c|}
			\hline
			\multicolumn{2}{|c|}{Acelerómetro} &\multicolumn{2}{|c|}{Giroscopio}   \\
			\hline
			Rango (g)        & Sensibilidad (LSB/g)  & Rango (\grad/seg)     & Sensibilidad (LSB/\grad/seg)\\ \hline
			$\pm 2$     &  16384 & $\pm 250 $  	& 	131      	\\ 
			$\pm 4$     &  8192  & $\pm 500 $ 	& 	65.5     	\\
			$\pm 8$     &  4096  & $\pm 1000$  	& 	32.8       	\\
			$\pm 16$    &  2048  & $\pm 2000$   & 	16.4      	\\ 
			\hline
		\end{tabular}
		\caption{Características de los sensores LSB: Bit Menos Significativo}
		\label{table:caracteristicasSensor}
	\end{table}
	
	\item \textbf{Variables:} Las variables entregadas por el Acelerómetro consiste en la aceleración lineal percibida en cada eje expresada en veces de g, y en el Giroscopio corresponde  a la velocidad angular dada por la variación de los grados en un instante de tiempo al girar sobre cada eje.
	
	\item \textbf{Frecuencia de Muestreo:} Nos describe la cantidad de datos que pueden ser obtenidos en un intervalo de tiempo, a su vez nos describe la diferencia de tiempo entre cada dato obtenido.
	
	\item \textbf{Resolución:} Consiste en la mínima variación generada en la variable medida y la cual los sensores son capaces de informar.
	
	\begin{table}[H]
		\centering
		\label{table:resolucionSensor}
		\begin{tabular}{|c|c|c|c|}
			\hline
			\multicolumn{2}{|c|}{Acelerómetro} &\multicolumn{2}{|c|}{Giroscopio}   \\
			\hline
			Rango (g)        & Resolución (LSB/g)  & Rango (\grad/seg)     &  Resolución (LSB/(\grad/seg))\\ \hline
			$\pm 2$     &  $6.10351562e^{-5}$   &$\pm 250 $ 	& 	$7.633587786e^{-3}$ 	\\ 
			$\pm 4$     &  $1.22070313e^{-4}$  	&$\pm 500 $ 	& 	$1.526717557e^{-2}$    	\\
			$\pm 8$     &  $2.44140625e^{-4}$ 	& $\pm 1000$  	& 	$3.048780488e^{-2}$		\\
			$\pm 16$    &  $4.88828125e^{-4}$   & $\pm 2000$    & 	$6.097560976e^{-2}$     \\ 
			\hline
		\end{tabular}
		\caption{Resolución de los sensores}
	\end{table}
	
\end{itemize}

\subsubsection{Configuración de MPU6050}
Por defecto el MPU6050 viene configurada con los parámetros básicos para realizar la captura de información, lo cual puede ser perfectamente útil según sea el caso de estudio, pero si se desea que los sensores operen en rangos específicos y/o los datos sean obtenidos a frecuencias específicas se debe comprender como llevar a cabo la configuración en cada uno de los registros internos encargados de cada configuración, el mapa de los registros \cite{MAPREGISTER} proporcionado  en el sitio de InverSense es buena guía para entender cómo se realiza esta labor.
\newline En el interior del MPU6050 se encuentran más de 70 registros cada uno de 8 Bit, para la configuraciones listadas a continuación se deben usar solo algunos pocos.
\begin{itemize}
	\item \textbf{Configurar frecuencia muestreo:} Para definir la cantidad de muestras que se obtendrán ``En Teoría'' se calcula usando la ecuación: 
	
	\begin{equation} 
	\label{eq:sampleratediv}
	Sample Rate = \frac{Gyroscope Output Rate}{(1 + SMPLRT\_DIV) }
	\end{equation}
	
	En la ecuación (\ref{eq:sampleratediv}) factores, tales como la velocidad del puerto serial pueden influir en el resultado, el registro \textbf{SMPRT\_DIV} es de 8 Bit entonces adminte valores entre 0 y 255, el valor de $Gyroscope Output Rate$ depende directamente del estado del filtro pasa-bajo, en caso de estar desactivado, el valor de $Gyroscope Output Rate$ sería 8Khz, en cambio sí está activado el $Gyroscope Output Rate$ tomaría el valor de 1Khz con lo cual haciendo los cálculos necesarios al estar desactivado el filtro pasa-bajo la frecuencia de muestreo variará entre las 8000 y 31 muestras/seg de forma teórica, al contrario en caso de estar activado el filtro, la fórmula para el cálculo de la frecuencia de muestreo fluctuaría entre las 1000 y 3.9 muestras/seg, por cada uno de los 6 datos obtenibles.
	
	Nota: Hay que tener en consideración que el valor obtenido para la frecuencia de muestreo es válido principalmente para el giroscopio, ya que para el acelerómetro es de a lo más un 1Khz por ende si la frecuencia de muestreo es mayor a 1Khz se pueden repetir valores en la salida del acelerómetro.
	
	\item \textbf{Configurar Giroscopio:} El registro GYRO\_CONFIG permite el cambio de los rangos para la obtención de la velocidad angular, con lo cual aumentamos o disminuimos de forma inversa la sensibilidad del Giroscopio. En el interior de este registro específicamente en los bits 3 y 4 del registro deben ser ingresados los valores en binario de los números 0, 1, 2 o 3 para configurar los cuatro rangos disponibles 250\grad/seg, 500\grad/seg, 1000\grad/seg y 2000\grad/seg. respectivamente.
	
	\item \textbf{Configurar Acelerómetro:} La configuración para el rango del acelerómetro se realiza de forma similar, solo que en cambio es utilizado el registro ACCEL\_CONFIG, en donde también los bits 3 y 4 corresponden a los valores en binario de 0, 1, 2 o 3 que representan $\pm 2g$, $\pm 4g$, $\pm 8g$, $\pm 16g$ respectivamente.
	
\end{itemize}

\subsubsection{Obtención mediciones Giroscopio y Acelerómetro}
Luego de realizar la configuración de los registros del MPU6050, se deben leer ciertos registros para la obtención de la información del movimiento registrado por los sensores inerciales:

\begin{itemize}
	\item \textbf{Obtención de la Velocidad Angular:} Para obtener la variación del ángulo por unidad de tiempo medida por el giroscópico, deben ser leídos 6 registros en donde son usados por cada eje medible 2 registros de 8 bit,
	
	\begin{table}[H]
		\centering
		\label{table:registrosgyro}
		\begin{tabular}{|l|l|c|l|c|}
			\hline
			\textbf{Eje} & \textbf{Registro} & \textbf{Dirección (Hex)} & \textbf{Registro} & \textbf{Dirección (Hex)} \\ \hline
			X            & GYRO\_XOUT\_H     & 0x43                     & GYRO\_XOUT\_L     & 0x44                     \\ \hline
			Y            & GYRO\_YOUT\_H     & 0x45                     & GYRO\_YOUT\_L     & 0x46                     \\ \hline
			Z            & GYRO\_ZOUT\_H     & 0x47                     & GYRO\_ZOUT\_L     & 0x48                     \\ \hline
		\end{tabular}
		\caption{Registros mediciones Giroscopio}					
	\end{table}
	
	Posteriormente de ser leídos ambos registros de cada eje estos deben ser sumados usando aritmética binaria en donde el valor obtenido del primer registro leído le es aplicado un corrimiento de 8 bit para luego sumar el segundo obtenido, además se utiliza el complemento a 2 para la obtención de valores negativos, que genera como dato resultante un valor de entre aproximadamente $\pm 2^{15}$, este valor resultante debe ser dividido según la sensibilidad asociada a el rango escogido del giroscopio, para transformar el dato RAW del giroscopio y obtener la información física en (\grad/seg).
	
	\item \textbf{Obtención de la Aceleración:} Para obtener la información del acelerómetro al igual que en Giroscopio deben ser leídos los 6 pertenecientes a las mediciones:
	
	\begin{table}[H]
		\centering
		\label{table:registrosaccel}
		\begin{tabular}{|l|l|c|l|c|}
			\hline
			\textbf{Eje} & \textbf{Registro} & \textbf{Dirección (Hex)} & \textbf{Registro} & \textbf{Dirección (Hex)} \\ \hline
			X            & ACCEL\_XOUT\_H     & 0x3B                     & ACCEL\_XOUT\_L     & 0x3C                     \\ \hline
			Y            & ACCEL\_YOUT\_H     & 0x3D                     & ACCEL\_YOUT\_L     & 0x3E                     \\ \hline
			Z            & ACCEL\_ZOUT\_H     & 0x3F                     & ACCEL\_ZOUT\_L     & 0x40                     \\ \hline
		\end{tabular}
		\caption{Registros mediciones Acelerómetro}					
	\end{table}				
	
	Para luego unir los registros y usar el complemento a 2 acorde a cada eje, cada uno de estos valores deben ser divididos según el rango escogido, que determina la sensibilidad a usar para obtener la información física de la aceleración.
	
	\begin{figure}[H]
		\centering
		\includegraphics[scale=0.6]{images/curvacalibracion}
		\label{fig:curvacalibracion}
		\caption{Ejemplo curva calibración $\pm 2g$}
	\end{figure}
	
\end{itemize}



\subsection{Protocolo de Comunicación $\mathbf{\mathrm{I^2C}}$}
La comunicación entre el sensor MPU6050 y Arduino se entabla mediante el protocolo $I^2C$.

El protocolo $I^2C$ fue desarrollado en 1982 por Philips Semiconductors (hoy NXP Semiconductors) para la comunicación interna entre circuitos integrados como por ejemplo juegos de CD y televisiones.

Las principales características del protocolo de Comunicación $\mathrm{I^2C}$ \cite{I2C} son:
\begin{itemize}
	\item Solo dos líneas para la comunicación son necesarias; una línea para la información serial (SDA) y otra para el reloj serial (SCL).
	
	\item Cada dispositivo conectado al bus es direccionado por software por un ID único y usando relación Esclavo/Maestro todo el tiempo.
	
	\item Posee un sistema de detección de colisiones lo que permite usar el modo multi-maestro previniendo la corrupción de los datos si dos o más maestros comienzan a transferir datos de forma simultánea.
	
	\item Orientado a transferencias de datos en 8-bit de forma bi-direccional pueden ser realizadas hasta los 100 kbit/s en el modo Estándar, hasta 400 kbit/s en el modo Rápido, hasta 1 Mbit/s en el modo Mas Rápido, o hasta 3.4 Mbit/s en el modo de Alta-Velocidad.
	
	\item En el chip de filtrado se rechazan los picos en la línea de datos del bus de preservar la integridad de datos.
	
	\begin{figure}[H]
		\centering
		\includegraphics[width=0.9\textwidth]{images/Diagrama_I2C}
		\caption{Diagrama $\mathrm{I^2C.}$}
		\label{fig:diagramaI2C}
	\end{figure}
\end{itemize}


\subsection{Framework QT}
Qt\cite{QT} es un Framework basado en C++, tiene disponibilidad multiplataforma- escritorio, móvil y sistemas embebidos.
Posee las bibliotecas bases de C++  junto a librerías y herramientas de desarrollo propias de Qt, en donde se incluye IDE Qt Creator, y herramientas de productividad .
El entorno de desarrollo (IDE) del framework de C++ Qt  es Qt Creator en donde se incluyen las herramientas para la administración de los ficheros .h y .cpp usados en C++ junto con las opciones de compilación, ejecución y depuración del software.


\section{Desarrollo}
\subsection{Introducción}
En este capítulo se describe la solucion y su respectivo desarrollo.
El sistema consta principalmente en un microcontrolador Arduino, un sensor inercial y un software que permite el registro de variables cinemáticas y Bio-realimentación (registro en tiempo real y representación visual) de la posición Ver Figura (\ref{fig:diagramasistema}).

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.25]{images/diagrama_sistema}
	\caption{Diagrama Sistema}
	\label{fig:diagramasistema}
\end{figure}

El sistema es definido y contrastado a partir del equipamiento existente en el Departamento de Kinesiologia. Para evaluación y realimentación de Balance, es decir, plataforma de fuerza Kistler y Sistema Balance SD.

En lo referente a hardware se utilizó un sensor inercial MPU6050, el cual es ubicado en el sujeto de prueba en una posición aproximada al centro de masa (aprox. 55\% de la altura). Este sensor es el encargado de capturar el movimiento generado por el sujeto la cual es  enviada a través del microcontrolador Arduino al software (PC) mediante conexión serial (USB). El software procesa la información(velocidad angular y aceleración lineal) para obtener el ángulo y desplazamiento, posteriormente permite efectuar análisis específicos de la información utilizando interfaces gráficas.


\subsection{Programación del Microcontrolador}
Uno de los primeros pasos en el desarrollo de la solución consiste en utilizar el IDE de Arduino para realizar la programación inicial del microcontrolador. La conexión del sensor MPU6050 permite la configuración y uso del sensor.
En la configuración se definen ciertos registros, además de precisar el formato de envío para despliegue de la informacion proveniente del sensor, consta de una línea con 6 datos separados por espacios.

La programación del microcontrolador se describe en la figura(\ref{fig:arduinocode}).
En el ciclo de ejecución de Arduino se requiere la configuración del sensor MPU6050. La configuración consta de 4 parámetros fundatemtanes: Frecuencia de Muestreo, Filtro pasa bajo, rango Acelerómetro, rango Giroscopio. Posteriormente comienza el envío de la información al software (PC) via Serial.

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.45]{images/diagramacodigoarduino}
	\caption{Diagrama Código Arduino}
	\label{fig:arduinocode}
\end{figure}

Finalizada la configuración se procede a la lectura de los registros para obtener los valores crudos RAW, tanto del acelerómetro como giroscopio. Finalmente se envía mediante comunicación serial el valor expresado en su unidad física correspondiente.

\subsection{Requisitos Funcionales Software}
\begin{itemize}
	\item El sistema debe ser capaz de registrar (aceleración lineal, velocidad angular, posición angular). Procesarlas y realizar análisis Biomecánico. Además debe procesar los registros para obtener una proyección del Centro de Masa.
	\item El sistema debe ser capaz de representar en Tiempo Real el desplazamiento del centro de masa.
	\item El sistema debe permitir la generación de reportes, con todas las variables estudiadas y analizadas durante la prueba, exportar datos crudos, gráficos, informes.
	\item El sistema debe permitir la configuración de los sensores, ajustar su sensibilidad rango.
	\item Se debe permitir la configuración de parámetros propios del uso del sistema. Por ejemplo: orientación del sensor, altura, tiempo de prueba, etc.
	\item En lo referente a análisis de los gráficos de resultados, debe ser posible calcular estadísticos, como media, desviación estándar y junto con los valores máximos y mínimos.
\end{itemize} 

\subsection{Requisitos No funcionales}
\begin{itemize}
	\item El sistema debe presentar una interfaz clara y sencilla, tanto en el manejo, como para la presentación de resultados.
	\item El sistema debe tener un nombre representativo.
	\item El sistema debe permitir análisis usando los gráficos y mostrando los cambios (recortes o ajustes) en tiempo real.
	\item El sistema debe ser flexibe, permitiendo su uso en otras aplicaciones.
\end{itemize}

\newpage
\subsection{Resumen de Características}
\begin{itemize}
	\item \textbf{Configurable:} El software permite configurar la mayoría de opciones que poseer el sensor MPU6050, puerto serial a utilizar, rangos para captura de información del movimiento, así como cantidad de datos que se representaran en pantalla, tamaños de los elementos a graficar, tiempos de prueba, limitar geométricamente el gráfico, entre otros.
	\item \textbf{Reportes:} Cada uno de los gráficos despliegan las medidas tomadas o presentan los resultados del ejercicio, estos pueden ser exportados, tanto como un conjunto de datos, o también generar una imagen de estos.
	\item \textbf{Herramientas de Análisis Gráficas:} Ventanas desplegables acompañadas a un gráfico que permiten de forma interactiva seleccionar partes del gráfico, para analizar intervalos según se estime conveniente y a su vez obtener de él datos como, los valores máximos y mínimos, la media, desviación estándar de los datos, y en el caso del desplazamiento obtener la velocidad media del intervalo analizado.
	\item \textbf{Persistencia de datos:} Usando un pequeño almacén de datos en SQlite, es posible mantener un registro con la información de los pacientes, con el fin de tenerlos almacenados para el momento en que sea realizada cada una de las pruebas seleccionarlos sin la necesidad de re-ingresarlos en cada momento.
	\item \textbf{Geometría Analítica} Se usó bastante la geometría analítica, para la generación y representación gráfica tanto de los objetivos en las pruebas, como para la intersección del movimiento realizado con cada uno de estos. De igual manera se utiliza la trigonometría para limitar el área del movimiento según el radio que sea definido para el examen.
\end{itemize}

\newpage
\subsection{Registro de variables cinemáticas}
El ángulo de inclinación modelo pendulo invertido\cite{gage_kinematic_2004} es la variable fundamental de este sistema.
Para efectos de análisis o representación final, a partir de las variaciones de aceleración lineal y velocidad angular detectadas por los sensores se realiza el cálculo del ángulo, que para efectos de pruebas es un indicador equivalente a la inclinación que ha realizado el sujeto.

\subsubsection{Referencia Dispositivo y Sensor}
El dispositivo cuenta con una referencia para indicar hacia donde se encuentran cada uno de sus ejes. La idea presentada a continuación fue con el objetivo de simplificar y permitir la mayor versatilidad al momento de instalar el sensor para realizar mediciones.

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.2]{images/referenciaDispositivo}
	\caption{Diagrama Referencia Dispositivo}
	\label{fig:referenciaDisp}
\end{figure}

Tal como se muestra en la Figura (\ref{fig:referenciaDisp}), la flecha roja de referencia apunta paralelamente, en el sentido positivo del eje y (MPU6050).
Esta referencia se debe considerar al momento de realizar la instalación en el sujeto y en análisis posteriores de los datos entregados por el sensor (acelerómetro y giroscopio).

\newpage

El listado de orientaciones predefinidas para referencia del sensor, junto con su diagrama de orientación esta listado en la tabla siguiente.

\begin{table}[H]
	\centering
	\begin{tabular}{|c|c|}
		\hline 
		\textbf{Orientación} & \textbf{Diagrama} \\ 
		\hline 
		Vertical Atrás &  \includegraphics[scale=0.2]{images/IMU/verticalatras}\\ 
		\hline 
		Vertical Frente  &  \includegraphics[scale=0.2]{images/IMU/verticalfrente} \\ 
		\hline 
		Vertical Derecha  &  \includegraphics[scale=0.2]{images/IMU/verticalderecha}  \\ 
		\hline 
		Vertical Izquieda & \includegraphics[scale=0.2]{images/IMU/verticalizquierda}   \\ 
		\hline 
		Horizontal Arriba &  \includegraphics[scale=0.2]{images/IMU/horizontalarriba}   \\ 
		\hline 
		Horizontal Abajo &  \includegraphics[scale=0.2]{images/IMU/horizontalabajo}   \\ 
		\hline 
	\end{tabular}
	\caption{Tabla listado de orientaciones pre-configuradas}
	\label{table:listadoOrientaciones}
\end{table}

En el software se encuentra un listado de orientaciones presentados en la Tabla \ref{table:listadoOrientaciones}.
Al momento de realizar alguna prueba la orientación debe estar acorde en el Antero-Posterior/Medio-Lateral que se registrará en el sujeto.

\newpage
\subsubsection{Cálculo Ángulo con Acelerómetro} Es posible usar el acelerómetro como inclinómetro. Este nos entrega el ángulo con gran exactitud espacial.

Para la obtención del ángulo se debe tener en consideración la orientación del dispositivo. Las orientaciones inicialmente disponibles (ver Tabla \ref{table:listadoOrientaciones}) y la ecuación que describe las variables a utilizar en cada una de ellas se listan a continuación (ver Tabla\ref{table:calculoAnguloAcelerometro}).

\begin{table}[H]
	\centering
	\begin{tabular}{|c|c|c|}
		\hline 
		\textbf{Orientación} & \textbf{Ángulo Medio-Lateral} & \textbf{Ángulo Antero-Posterior} \\ 
		\hline 
		Vertical Atrás & $\tan{\left(\frac{-aceleracionX}{\sqrt{aceleracionZ^{2}+aceleracionY^{2}}}\right)} $ &  $\tan{\left(\frac{aceleracionZ}{\sqrt{aceleracionX^{2}+aceleracionY^{2}}}\right)} $ \\ 
		\hline 
		Vertical Frente & $\tan{\left(\frac{aceleracionX}{\sqrt{aceleracionZ^{2}+aceleracionY^{2}}}\right)} $ &  $\tan{\left(\frac{-aceleracionZ}{\sqrt{aceleracionX^{2}+aceleracionY^{2}}}\right)} $ \\ 
		\hline 
		Vertical Derecha & $\tan{\left(\frac{-aceleracionZ}{\sqrt{aceleracionX^{2}+aceleracionY^{2}}}\right)} $ &  $\tan{\left(\frac{-aceleracionX}{\sqrt{aceleracionZ^{2}+aceleracionY^{2}}}\right)} $ \\ 
		\hline 
		Vertical Izquieda & $\tan{\left(\frac{aceleracionZ}{\sqrt{aceleracionX^{2}+aceleracionY^{2}}}\right)} $ &  $\tan{\left(\frac{aceleracionX}{\sqrt{aceleracionZ^{2}+aceleracionY^{2}}}\right)} $ \\ 
		\hline 
		Horizontal Arriba &  $\tan{\left(\frac{aceleracionY}{\sqrt{aceleracionX^{2}+aceleracionZ^{2}}}\right)} $ &  $\tan{\left(\frac{-aceleracionX}{\sqrt{aceleracionY^{2}+aceleracionZ^{2}}}\right)} $ \\ 
		\hline 
		Horizontal Abajo & $\tan{\left(\frac{aceleracionY}{\sqrt{aceleracionX^{2}+aceleracionZ^{2}}}\right)} $ &  $\tan{\left(\frac{aceleracionX}{\sqrt{aceleracionY^{2}+aceleracionZ^{2}}}\right)} $ \\ 
		\hline 
	\end{tabular}
	\caption{Tabla cálculo ángulo usando Acelerómetro}
	\label{table:calculoAnguloAcelerometro}
\end{table}



\subsubsection{Cálculo Ángulo con Giroscopio}
Para el cálculo del ángulo de inclinacion a partir de las variables entregadas por el Giroscopio (velocidad angular). Utilizando integración numérica a partir de las diferencias temporales de la velocidad angular se obtiene la posición angular (ángulo de inclinación).

La velocidad angular para describir el ángulo Antero-Posterior/Medio-Lateral es relacionado directamente con la orientacion del dispositivo, por ende en la Tabla (\ref{table:calculoAnguloGiroscopio}) se lista la velocidad angular utilizada para cada caso.



\begin{table}[H]
	\centering
	\begin{tabular}{|c|c|c|}
		\hline 
		\textbf{Orientación} & \textbf{Medio-Lateral} & \textbf{Antero-Posterior} \\ 
		\hline 
		Vertical Atrás & $\omega= -GiroscopioZ$ &  $\omega= -GiroscopioX$ \\ 
		\hline 
		Vertical Frente & $\omega= GiroscopioZ$ &  $\omega= GiroscopioX$ \\
		\hline 
		Vertical Derecha & $\omega= GiroscopioX$ &  $\omega= -GiroscopioZ$ \\ 
		\hline 
		Vertical Izquieda & $\omega= -GiroscopioX$ &  $\omega= GiroscopioZ$ \\ 
		\hline 
		Horizontal Arriba & $\omega= GiroscopioX$ &  $\omega= GiroscopioY$ \\ 
		\hline 
		Horizontal Abajo & $\omega= -GiroscopioX$ &  $\omega= GiroscopioY$ \\ 
		\hline 
	\end{tabular}
	\caption{Tabla cálculo ángulo usando Giroscopio} 
	\label{table:calculoAnguloGiroscopio}
\end{table}



\subsubsection{Ventajas y desventajas}

El Acelerómetro es demasiado sensible a variaciones en la aceleración en cualquiera de sus 3 ejes. Estas variaciones pueden no ser producto tan solo de la fuerza gravitacional, por ende son generadas medidas erráticas debido a los cambios de aceleración constantes al girar/mover la IMU.

A partir de la variación de velocidad angular se puede obtener una aproximación bastante precisa de la diferencia de ángulos en cada instante.
El Giroscopio no posee una referencia del origen de la mediciones(ángulo inicial), por lo tanto es difícil de contrastar la información con el movimiento realizado.
La falta de una referencia inicial dificulta enormemente la interpretación. Con el tiempo los datos capturados por el Giroscopio comienzan a acumular un pequeño error, a estos errores acumulados se les conoce como drift o deriva.

\subsection{Métodos implementados para obtención del Ángulo}
En el software se implementaron 3 algoritmos: (a) Sin filtro, (b) Filtro de Kalman y (c) Filtro Complementario (ver Figura \ref{fig:selectorFiltros}), los cuales serán descritos y explicados a continuación.
	
\begin{figure}[H]
\centering
	\includegraphics[scale=0.9]{images/implementacionFiltros}
	\caption{Selector de filtros en Software}
\label{fig:selectorFiltros}
\end{figure}

\subsubsection{Sin Filtro} El punto de partida para el cálculo del ángulo consiste en la implementación tan solo usando el acelerómetro. Esta implementación es la base para cada uno de los filtros.

A partir de la fórmula de la tangente, según la orientación escogida son conjugados los ejes leídos directamente de los sensores, con el fin de aplicar la formula en el sentido que corresponda ver Tabla \ref{table:calculoAnguloAcelerometro}.


Para el análisis del desplazamiento del centro de masa se requiere que el ángulo obtenido sea lo en su medida lo más preciso, para ello se estudiaron e implementaron 2 filtros que permiten una correcta integración de los datos de aceleración lineal con velocidad angular.

Con el ángulo obtenido a partir del acelerómetro, existe la opción de agregar más información para corregir/mejorar la aproximación.


\subsubsection{Descripción Filtro Complementario}
El Filtro complementario es ampliamente usado en unidades inerciales y sistemas de visión. Este filtro es en sí es un filtro de Kalman de estado estacionario para una cierta clase de problemas de filtrado \cite{TesisUSM}.

Está compuesto por la una unión de dos filtros diferentes:
\begin{itemize}
	\item \textbf{Filtro Pasa-Bajo:} Se usa para eliminar las frecuencias altas del acelerómetro, por lo cual dejamos pasar bajo ciertas frecuencias, para eliminar el ruido detectado por el cambio de aceleración (vibración principalmente) en los ejes del acelerómetro.
	\item \textbf{Filtro Pasa-Alto:} Se aplica en las mediciones obtenidas por el giroscopio, para eliminar el drift acumulado en el tiempo, dejando pasar solo las de una frecuencia más alta.
\end{itemize}

Todo lo anterior queda descrito usando la siguiente Ecuación (\ref{eq:ecuacionFiltroComplementario}):

\begin{equation}
\label{eq:ecuacionFiltroComplementario}
anguloActual = (1-\alpha)*(anguloAnterior+\omega*dt)+(\alpha)*anguloAcelerometro
\end{equation}

En donde cada uno de las variables representa lo siguiente:
\begin{itemize}
	\item \textit{anguloAcelerometro:} El ángulo calculado mediante la aceleración obtenida por el Acelerómetro.
	\item $\omega$: Es la velocidad angular obtenida por el Giroscopio que hemos calculado previamente.
	\item \textit{dt:} Corresponde a la variación en segundos desde la última vez que se aplicó el filtro para calcular el ángulo.
	\item $\alpha$: Representa la contribución realizada por cada ángulo, Si $\alpha$ es igual 0 el cálculo del ángulo se realiza con el giroscopio en caso contrario $\alpha$ igual a 1 corresponde al ángulo del acelerómetro.
\end{itemize}

\subsubsection{Implementación Filtro Complementario}
Se posee un acelerómetro que entrega ángulos con referencia en la posición del sensor, pero muy susceptible a la variación de cambios de aceleración del éste y en cambio un giroscopio que permite calcular la variación de ángulo (usando integración numérica), pero sin tener una clara referencia de la posición donde está el sensor (ángulo inicial).

Para unificar la información proveniente de ambos sensores existe un filtro, que nació principalmente de la práctica, conocido como el Filtro Complementario \cite{TesisUSM}.
El filtro requiere un ángulo de punto de partida y para esto se utiliza el acelerómetro para recoger el ángulo inicial, ya que, al poseer la referencia de la gravedad, se obtiene el ángulo inicial para las posteriores iteraciones del filtro.


A partir de la ecuación del Filtro complementario (\ref{eq:ecuacionFiltroComplementario}), los parámetros necesarios para el cálculo del ángulo usando este filtro, corresponden a los Ángulos Previamente Calculados usando este mismo filtro y a su vez el Ángulo del acelerómetro que se calcula según la orientación ver Tabla (\ref{table:calculoAnguloAcelerometro}).
Entonces el parámetro nuevo a considerar es la velocidad angular $\omega$ que debe ser utilizada según la orientación del dispositivo, de igual forma como es utilizada al calcular el ángulo con el Giroscopio (ver Tabla \ref{table:calculoAnguloGiroscopio}).


Nota: el $dt$ es obtenido a partir de la diferencia entre la muestra actual y la anterior, por ende para el ángulo de inicio es considerado sólo el obtenido por el acelerómetro.

\subsubsection{Descripción Filtro de Kalman discreto}
El filtro de Kalman es un estimador lineal, insesgado y óptimo del estado de un proceso. En él se ha impuesto la condición de que el proceso a ser estimado es regido por una dinámica lineal y que el ruido que lo perturba es blanco y gaussiano. Aun cuando la condición del comportamiento probabilístico gaussiano del ruido se omite, el filtro de Kalman sigue siendo el mejor filtro recursivo lineal (error de menor varianza) e insesgado\cite{TesisUSM}.

Su propósito es emplear las mediciones obtenidas en un período de tiempo que a su vez son afectadas por variaciones  aleatorias (ruido) junto con el conocimiento del comportamiento del sistema, para producir estimaciones que tiendan a estar más cerca del valor real del proceso en cuestión. Todas las mediciones y cálculos basados en modelos son aproximaciones en cierto grado obtenidas a partir de datos ruidosos provenientes de los sensores.

EL filtro de Kalman posee flexibilidad para ser utilizado tanto en tiempo continuo o en tiempos discretos.

El Filtro consiste en 2 estados Predicción y Actualización.

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.65]{images/kalman-filter.png} 
	\caption{Diagrama estados Filtro Kalman}
	\label{fig:diagramakalman}
\end{figure}

\subsubsection{Implementacion FIltro de Kalman discreto}
A partir de la información proveniente de las mediciones del Proceso de captura de información cinemática, se intenta obtener el ángulo, con la premisa que el filtro retornará el mínimo error por las fluctuaciones entrantes del ruido en las mediciones obtenidas.

La implementación realizada se basa en el uso de las libredias de C++ propuesta en [\cite{kalmanTKJ}]. Su implementación es sencilla, y los parámetros necesarios son exactamente los mismos utilizados por el filtro complementario.

Los parámetros de entradas para la utilización del filtro sin los mismos descritos en las tablas (\ref{table:calculoAnguloAcelerometro}) y (\ref{table:calculoAnguloGiroscopio}).
Debe ser considerado el \textit{nuevoAngulo} entregado mediante el acelerómetro y además la \textit{nuevaVelocidadAngular} obtenida por el giroscopio, junto con la diferencia de tiempo \textit{dt}, que corresponden a exactamente los mismos datos usados por el filtro complementario.


\subsubsection{Comparativa de Métodos}
Luego de la integración de los filtros en el Software es posible utilizar el deseado para la prueba, pero se deben tener en consideración las ventajas de usar los filtros implementados. A continuación se realizó una breve comparativa para ver el comportamiento entre el cálculo del ángulo sin utilizar filtros, usando filtro complementario y Kalman para la obtención durante la misma prueba.

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.75]{images/angKalCom}
	\caption{Comparativa Angulo Acelerómetro vs Filtro Kalman vs Filtro Complementario}
	\label{fig:AnguloXvsFiltros}
\end{figure}

Pese a primera vista que la gráfica ver Figura (\ref{fig:AnguloXvsFiltros}) demuestra la gran corrección que realizan los filtros frente a el cálculo sin estos, los análisis que pueden ser concluidos respecto al cálculo del ángulo:
\begin{itemize}
	\item \textbf{Cálculo del ángulo sin usar filtros:} la diferencia entre los filtros vs el Cálculo sin el uso de estos es significativa, en especial respecto al ruido apreciable que es reducido en gran medida por la incorporación de algún filtro.
	\item \textbf{Aplicando filtros:} el uso del filtro mejora considerablemente el ruido obtenido, pero a su vez si son comparados ambos filtros disponibles, estos tienen un comportamiento similar, sin entrar en estudios complejos acerca de cual es más óptimo, es completamente a criterio del usuario el filtro que aplicará.
	Para efectos de análisis posteriores se utilizará el filtro de Kalman.
\end{itemize}


\subsection{Cálculo del Desplazamiento del Centro de Masa en el plano}

Basado en la premisa que la posición bípeda-quieta puede ser representada como un péndulo invertido\cite{gage_kinematic_2004}, entonces el movimiento pendular de un sujeto en las coordenadas antero-posterior y medio-lateral puede ser obtenida a partir de relaciones geométricas(trigonometría), con ello obtener el desplazamiento.


\subsubsection{Proyección del angulo}
Para obtener la distancia proyectada en el eje horizontal (proyección del COM en el plano), la altura $h$ consiste en la distancia desde el suelo hasta donde fue puesto el sensor. Esta altura es equivalente a la hipotenusa de un triángulo rectángulo, como se muestra en la Figura (\ref{fig:proyeccion}). Mediante la ecuación (\ref{eq:proyeccion}) obtenemos la proyección en el plano horizontal (d). La distancia $d$ corresponde al desplazamiento del centro de masa estimado.

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.6]{images/calculoProyeccion}
	\caption{Ejemplo cálculo Proyección Angulo}
	\label{fig:proyeccion}
\end{figure}

\begin{equation}
	\label{eq:proyeccion}
	d=\sin(\alpha)*h
\end{equation}

\newpage
\subsubsection{Recorrido curvo del ángulo}
La longitud del arco generado por el ángulo puede ser considerado el desplazamiento, por ello fue implementado.
El arco correponde a la proporción del perímetro de la circunferencia en términos del ango $\alpha$ (ver Ecuación \ref{eq:recorridocurvo}).

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.7]{images/calculoRecorridoCurvo}
	\caption{Ejemplo cálculo Recorrido Curvo}
	\label{fig:recorridocurvo}
\end{figure}

\begin{equation}
	\label{eq:recorridocurvo}
	arco=\left(\frac{\alpha*2\pi}{360}\right)*h
\end{equation}

\newpage
\subsubsection{Comparación métodos Cálculo Desplazamiento}
Para comparar el desplazamiento real del COM y el desplazamiento proyectado en el plano se realiza un ejemplo para un COM ubicado a 1m. del suelo.

A continuación se presenta una tabla con valores de ejemplo para comparar el comportamiento de las dos fórmulas para el cálculo del desplazamiento, y además un gráfico para comparar la diferencia entre ellos.

\begin{figure}[H]
	\begin{subfigure}{.5\textwidth}
		\scalebox{0.75}{
		\begin{tabular}{|c|c|c|c|}
			\hline 
			\textbf{Ángulo} & \shortstack{\textbf{Recorrido}\\\textbf{ (arco)}} & \textbf{Proyección (d)} & \textbf{Diferencia}\\ 
			\hline 
			0 & 0.00000 & 0.00000 & 0.00000 \\
			\hline 
			10 & 17.45329 & 17.36482 & 0.08847 \\ 
			\hline 
			20 & 34.90659 & 34.20201 & 0.70457 \\ 
			\hline 
			30 & 52.35988 &50.00000 & 2.35988 \\ 
			\hline 
			40 & 69.81317 & 64.27876 & 5.53441 \\ 
			\hline 
			50 & 87.26646 & 76.60444 & 10.66202 \\ 
			\hline 
			60 & 104.71976 & 86.60254 & 18.11721 \\ 
			\hline 
			70 & 122.17305 & 93.96926 & 28.20379\\ 
			\hline 
			80 & 139.62634 & 98.48078 & 41.14556 \\ 
			\hline 
			90 & 157.07963 & 100.00000 & 57.07963 \\ 
			\hline
		\end{tabular}
	}
		
	\end{subfigure}
	\begin{subfigure}{.5\textwidth}
		\includegraphics[width=.9\linewidth]{images/DiferenciaRec-Pro}
		\label{fig:comparacionDesplazamiento}
	\end{subfigure}%
		\captionlistentry[table]{Comparación Recorrido Curvo - Proyección}
		\captionsetup{labelformat=andtable}
		\caption{Comparación Recorrido Curvo - Proyección}
\end{figure}

Al comparar los métodos anteriormente mencionados para el cálculo del desplazamiento Recorrido Curvo y Proyección, estos se comportan de forma similar en ángulos pequeños (d$\approx\sin\alpha$). Pero a medida que el valor del ángulo comienza a crecer se incrementa la diferencia, debido a que la distancia calculada mediante el recorrido curvo es mayor frente a la obtenido por proyección.

Por lo tanto se debe tener en consideración al momento de escoger con que método se realizará el cálculo, ya que con ambos se puede interpretar el desplazamiento. Para el estudio del balance los ángulos varían entre ($\pm 3$\grad), con lo cual según los análisis expuestos anteriormente ambos métodos se comportan de forma similar en ese rango.
Dicho esto de ahora en adelante cuando sea realizado el cálculo del desplazamiento se utilizará el método de la proyección.


\newpage
\subsection{Desarrollo de Software}
Un parte importante del sistema es la interfaz que permite al usuario interactuar con el micro-controlador-sensor, tomar registros, almacenarlos, etc.
Se implementó utilizando en Framework QT(C++)\cite{QT} en su versión Open-Source.
Al estar basado en C++ en estabilidad y rendimiento es una de las mejores opciones a tener en consideración.
El usar un framework como Qt facilita en gran parte la creación de interfaces gráficas, capa de funcionalidad que C++ no contiene por defecto, esto posibilita una rápida integración entre la parte lógica y visual del software a desarrollar.

El software permite la captura y procesamiento de información proveniente del sensor mediante comunicación serial entre el micro-controlador Arduino y el ordenador.

Debido a el tipo de proyecto a implementar la metodología usada para el desarrollo fue el método ágil, al ser una solución de software con requisitos funcionales poco definidos, más que nada pautas del resultado esperado en donde el programador pasa a ser es el principal diseñador definiendo por sí mismo la distribución y comportamiento de los componentes del software.

En etapas tempranas del desarrollo se implementó una interfaz de comunicación con el puerto serial, pudiendo conectarse a este, y obtener la información disponible.
Durante el desarrollo se incluyeron más opciones para una visualización más adecuada, junto con la parametrización de todos los elementos mostrados, permitiendo al usuario activar y desactivar opciones según sea el caso.

La comunicación serial entre el dispositivo-ordenador permite leer los datos en el puerto y enviar parámetros para realizar la configuración del sensor.
Esto es realizado con el fin de establecer el valor de opciones consideradas más relevantes tales como: la frecuencia de muestreo, el uso del filtro Pasa-Bajo y los rangos del Acelerómetro y Giroscopio, a través de una interfaz sencilla e intuitiva ver Figura (\ref{fig:ajustessensores}).

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.6]{images/ajustesSensores}
	\caption{Ventana Ajustes Sensores}
	\label{fig:ajustessensores}
\end{figure}

\newpage
Al momento de iniciar la aplicación si es que son detectados dispositivos en el puerto Serial se lanza la interfaz principal (ver Figura \ref{fig:mainwindow}), en donde se elige un paciente y la prueba a realizar.

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.6]{images/mainwindow}
	\caption{Ventana Principal}
	\label{fig:mainwindow}
\end{figure}

Luego de seleccionada la prueba, según el tipo elegida se permite configurar ciertos elementos.
Las pruebas incluidas son las siguientes:
\begin{itemize}
	\item \textbf{Romberg Modificado:} 
	\item \textbf{Prueba Base:}
	\item \textbf{Modo Libre:}
	\item \textbf{Análisis en Tiempo A-P M-L:}
\end{itemize}
\begin{figure}[H]
	\centering
	\includegraphics[scale=0.6]{images/configurarPrueba}
	\caption{Ventana Configuración Prueba}
	\label{fig:configurarPrueba}
\end{figure}

La ventada de configuración (Figura \ref{fig:configurarPrueba}) considera los siguientes parámetros.

\begin{itemize}
	\item \textbf{Orientación Sensores:} Es una de las principales configuraciones a tener en consideración, debido a que define como está siendo situado el equipo, y a su vez como será analizada la información.
	Existen 2 categorías de orientación:
	\begin{itemize}
		\item \textbf{Horizontal:} En donde se puede definir si la referencia esta hacia adelante, atrás, izquierda o derecha, si esta orientación es seleccionada el cable siempre está conectado en la parte inferior del dispositivo.
		\item \textbf{Vertical:} Solo fueron considerados 2 modos, ya que de por si la orientación horizontal es poco práctica para los estudios del balance.
		Los modos disponibles son con la referencia arriba o abajo, considerando que el cable siempre sale hacia la derecha del dispositivo.
	\end{itemize}
	\item \textbf{Ajustes Objetivos:} En el gráfico principal se pueden desplegar objetivos para ser seguidos.
	\begin{itemize}
		\item \textbf{Cantidad de Objetivos:} Permite definir cuantos objetivos van a ser dibujados en pantalla, se debe tener en consideración los radios tanto de los objetivos, como del gráfico circular donde serán puestos, dado que si la cantidad de objetivos no es posible de dibujar, serán agregados la cantidad máxima posible sin que se intersecten.
		\item \textbf{Generar en orden Aleatorio:} Esta opción permite que objetivos pueden ser puestos en posiciones al azar dentro del gráfico o seguir una trayectoria circular.
		\item \textbf{Marcables en orden:} Esta opcion permite definir la interacción con los objetivos.
		Si esta activada los objetivos parpadearán según el orden que fueron agregados permitiendo marcar solo uno, sino no parpadearán indicando que es posible marcar cualquier objetivo.
		\item \textbf{Detener prueba al marcar todos:} Esta opción permite definir si al pasar por todos los objetivos es finalizada la prueba o continua .
	\end{itemize}
	
	\item \textbf{Ajustes Finales} Las otras opciones y parámetros del software son:
	\begin{itemize}
		\item \textbf{Altura dispositivo:} La altura donde está puesto el dispositivo, que servirá para los cálculos de desplazamientos realizados.
		\item \textbf{Limitar el borde al gráfico:} Permite que la curva dibujada sobre el gráfico pueda salir o no del Radio Exterior de este.
		\item \textbf{Tiempo Prueba:} La cantidad de segundos que durará la prueba, o si esta se realizará de tiempo infinito.
	\end{itemize}
\end{itemize}

Nota: Algunos ajustes pueden interferir en el funcionamiento de otros, por ejemplo si es seleccionada la opción de Detener al marcar todos, pese a que el tiempo sea infinito la prueba terminará si se cumple la condición.

\newpage
Luego de realizar la configuración y presionando el botón Iniciar Prueba, se procede a desplegar la información obtenida, en forma de gráficos.

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.76]{images/graficoPrincipal}
	\caption{Gráfico de Prueba}
	\label{fig:graficoPrincipal}
\end{figure}

El sistema permite el registro y visualización de los datos crudos (sin procesar) provenientes de los sensores, los cuales pueden ser visualizados y exportados.

\begin{figure}[H]
	\centering
	\frame{\includegraphics[scale=0.3]{images/graficosensores}}
	\caption{Gráficos de los sensores}
	\label{fig:Graficosensores}
\end{figure}


Finalmente para el análisis de la información se dispone de herramientas intuitivas que permiten seleccionar intervalos, para el cálculo de estadísticos de la prueba, media, máximos, mínimos, etc. ver Figura (\ref{fig:analsisGraficos}).

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.3]{images/analisisGraficos}
	\caption{Ejemplo Herramienta de Análisis}
	\label{fig:analsisGraficos}
\end{figure}

Cabe destacar que cualquier cambio sobre los intervalos a estudiar calcula los datos en tiempo real.

\newpage
\subsection{Resultados y Análisis}
Con respecto a la comparación entre los paradigmas usados para el análisis del desplazamiento del centro de Masa, la utilización de sensores piezo-eléctricos para la presión ejercida por el sujeto (COP), en contraste por el estudiado en esta Tesis, utilizando acelerometría para obtener la variación espacial del centro de masa (COM), los resultados y análisis de las pruebas realizadas serán descritos a continuación.

\subsubsection{Contraste Dispositivo vs Plataforma de Fuerza Kistler}

El método que fue empleado para verificar la fidelidad con que es representada la información obtenida mediante el uso de acelerometría junto con los cálculos realizados para obtener la variación del centro de masa, es compararlo frente a un Gold Standard en términos de análisis de balance y/o desplazamiento del COM.

Para ello se realizaron tres pruebas, ubicando el dispositivo en las siguientes zonas: espalda, costado, frente del sujeto.
El objetivo en las pruebas era medir principalmente la variación Antero-Posterior, ya que, en términos de balance es donde una mayor variación es percibida.

El paciente tenía una estatura de 1.78 cm, el dispositivo en todas las pruebas fue ubicado a una altura de 97.6 cm, el aproximado del 55\%.
Los registros en la plataforma Kistler fueron tomados a una frecuencia de 100hz y para el dispositivo a 200hz. 
Para la sincronización temporal fue utilizada la correlación cruzada, con la cual se obtiene el retraso(lag) entre las señales, para posteriormente sincronizarlas, y para ello fue necesario sub-muestrear los datos del dispositivo (decimate en octave) a 100hz.

El dispositivo fue evaluado en 3 posiciones:
\begin{enumerate}
	\item \textbf{Espalda} 
	\item \textbf{Lateral Izquierdo}
	\item \textbf{Espalda}
\end{enumerate}

\newpage
\subsubsection{Prueba Espalda} En la siguiente prueba el dispositivo fue ubicado en la espalda, en zona las vértebras lumbares del sujeto. Se realiza la medición en la Plataforma Kistler en conjunto con el \nombreDispositivo creado con objetivo de Tesis.
		
	
	\begin{figure}[H]
		\centering
		\begin{subfigure}{.5\textwidth}
			\centering
			\includegraphics[width=1\linewidth]{images/pruebas/Espalda/Antero-Posterior}
			\caption{Antero-Posterior}
			\label{fig:anteroPosteriorEspalda}
		\end{subfigure}%
		\begin{subfigure}{.5\textwidth}
			\centering
			\includegraphics[width=1\linewidth]{images/pruebas/Espalda/Medio-Lateral}
			\caption{Medio-Lateral}
			\label{fig:medioLateralEspalda}
		\end{subfigure}
		\caption{Prueba \nombreDispositivo ubicado Espalda}
		\label{fig:pruebaEspalda}
	\end{figure}
	
	En los resultados obtenidos de la prueba se puede apreciar la gran similitud del comportamiento de ambas curvas.
	
	Para los gráficos obtenidos anteriormente tan solo debió realizarse un ajuste temporal de las series temporales.



\newpage
\subsubsection{Prueba Lateral Izquierdo}
	Para esta prueba el \nombreDispositivo fue ubicado en el lateral izquierdo del sujeto a altura de la cadera.
		
	\begin{figure}[H]
		\centering
		\begin{subfigure}{.5\textwidth}
			\centering
			\includegraphics[width=1\linewidth]{images/pruebas/LateralIzquierdo/Antero-Posterior}
			\caption{Antero-Posterior}
			\label{fig:anteroPosteriorLateral}
		\end{subfigure}%
		\begin{subfigure}{.5\textwidth}
			\centering
			\includegraphics[width=1\linewidth]{images/pruebas/LateralIzquierdo/Medio-Lateral}
			\caption{Medio-Lateral}
			\label{fig:medioLateralIzquierdo}
		\end{subfigure}
		\caption{Prueba \nombreDispositivo ubicado Lateral Izquierdo}
		\label{fig:pruebaLateralIzquierdo}
	\end{figure}
	
	Los resultados obtenidos inicialmente se encontraban desplazados, es decir, las curvas no coincidían, pero al centrar los datos, las curvas del desplazamiento coinciden en gran porcentaje en cuanto a la tendencia, altos y bajos.
	Esta traslación se debe principalmente a que el dispositivo fue instalado en una distancia más lejana al centro de masa del sujeto, pero pese a esa distancia adicional es posible analizar el comportamiento del desplazamiento de éste.
	
\newpage
\subsubsection{Prueba Frontal}
El procedimiento fue similar a las anteriores descritas, tan solo que en la mitad de la prueba se comenzo a generar variaciones medio-laterales por el sujeto de pruebas, con el fin de registrar una mayor variación en los registros.

Los resultados obtenidos son los siguientes:
	
	\begin{figure}[H]
		\centering
		\begin{subfigure}{.5\textwidth}
			\centering
			\includegraphics[width=1\linewidth]{images/pruebas/Frontal/Antero-Posterior}
			\caption{Antero-Posterior}
			\label{fig:anteroPosterioFrontal}
		\end{subfigure}%
		\begin{subfigure}{.5\textwidth}
			\centering
			\includegraphics[width=1\linewidth]{images/pruebas/Frontal/Medio-Lateral}
			\caption{Medio-Lateral}
			\label{fig:medioLateralFrontal}
		\end{subfigure}
		\caption{Prueba \nombreDispositivo ubicado Frontal Sujeto}
		\label{fig:pruebaLateralFrontal}
	\end{figure}
	
Los datos tanto en el sentido Antero-Posterior, como en el medio lateral sufrieron de traslación, con lo cual debieron ser ajustados para realizar una comparación más directa.

\newpage
\subsubsection{Resumen de Resultados}

Para comparar los resultados se definieron medidas de diferencia y error para comparar el comportamiento de las series temporales utilizando estos dos sistemas (dispositivo v/s Kistler). 

Sin más que acotar a continuación se encuentra la definición de todas las ecuaciones utilizadas para obtener los cálculos  en tabla de Resultados.
\newline

\begin{table}[H]
	\begin{tcolorbox}[colframe=black,title=Definición de ecuaciones,center title]	
		
		\begin{align}
		{Kistler}:S_{K} &= \left\lbrace \begin{array}{lcl}
		AP_{K} & : & \scalebox{0.6}{\textrm{Serie temporal Antero-Posterior de Kistler}}\\
		ML_{K} & : & \scalebox{0.6}{\textrm{Serie temporal Medio-Lateral}}\\
		\end{array} \right. \label{eq:seriesKistler} \\
		{Dispositivo}:S_{D} &= \left\lbrace \begin{array}{lcl}
		AP_{D} & : & \scalebox{0.6}{\textrm{Serie temporal Antero-Posterior \nombreDispositivo}}\\
		ML_{D} & : & \scalebox{0.6}{\textrm{Serie temporal Medio-Lateral \nombreDispositivo}}
		\end{array} \right. \label{eq:seriesDisposito}
		\end{align}
		
		En las siguientes definiciones $*$ equivale a Antero-Posterior o Medio Lateral.
		
		\begin{align} 
		Rango:	R^{*}&=Max(S_{K}^{*})-Min(S_{K}^{*})\\
		Diferencia:	\Delta^{*}&=S_{K}^{*}-S_{D}^{*}\\
		\textrm{Coeficiente Correlacion}: r&=Cov\\
		\textrm{Error medio porcentual}:	Error^{*}&=\left( \frac{\sum\limits_{i=1}^{n}|\Delta^{*}|}{n} \right)*\frac{100}{R^{*}} \\
		\textrm{Mínima diferencia porcentual}:	Min\Delta^{*}&=Min(\Delta^{*})*\frac{100}{R^{*}}\\
		\textrm{Máxima diferencia porcentual}:	Max\Delta^{*}&=Max(\Delta^{*})*\frac{100}{R^{*}}
		\end{align}	
	\end{tcolorbox}
	\caption{Definición de ecuaciones}
	\label{table:definicionEcuaciones}
\end{table}

\begin{table}[H]
	\centering
	\begin{tabular}{|c|c|c|c|c|c|c|}
		\hline
		\multirow{2}{*}{Pruebas} &
		\multicolumn{2}{c|}{Espalda} &
		\multicolumn{2}{c|}{Izquierda} &
		\multicolumn{2}{c|}{Frontal} \\
		\cline{2-7}
		& A.P & M.L & A.P  & M.L & A.P & M.L \\
		\hline
		\shortstack{Coeficiente\\Correlación} & 0.98790 &0.90179 & 0.94307 & 0.81876 & 0.94733 & 0.96013 \\
		\hline
		\shortstack{Rango\\Kistler (cm)} & 18.655 & 4.6465 & 17.679 & 4.9096 & 19.085 & 19.105 \\
		\hline
		\shortstack{Error Medio\\Porcentual} & 3.9034 & 5.7586 & 8.9823 & 8.1358 & 9.2246 & 4.6773 \\
		\hline
		\shortstack{Mínimo Error\\Porcentual} & 5.3548$e^{-4}$ & 0.0024053 & 0.0030168 & 0.0031829 & 0.0063938 & 0.0016166 \\
		\hline
		\shortstack{Máximo Error\\Porcentual} & 14.952 & 22.976 & 35.381& 30.957 & 32.014 & 28.542 \\
		\hline
	\end{tabular}
	\caption{Tabla resultados pruebas}
	\label{table:resultadosPruebas}
\end{table}	

\subsubsection{Discusión de Resultados}
Al tener el conjunto de resultados resumidos en una tabla con datos concretos, es posible realizar la comparación, para determinar la precisión para representar el dezplazamiento del COM por el dispositivo frente a la plataforma Kistler, y además como afecta la ubicación del dispositivo.

Si es considerada la correlación entre los datos de las 3 pruebas, la que presenta una mayor correlación en términos de Antero-Posterior y Medio-Lateral consiste en las pruebas con el dispositivo Frontal y Espalda, al estar el centro de masa aproximadamente cerca de esa posición, era un resultado esperable, en cambio si son analizadas por separado, la prueba que representa mejor la variación Antero-Posterior, consiste en la prueba con el sensor en la Espalda, y para el medio lateral, el dispositivo al Frente del sujeto.

La prueba que arrojo menores cantidades de error en comparación con la plataforma Kistler, fue con el dispositivo en la Espalda del sujeto, por contra-parte la que ofrece más diferencias(error) es con el dispositivo en la parte Lateral Izquierda fue la que entrega un error mayor.

El hecho que en la prueba con el dispositivo en la Espalda no necesitara un gran ajuste en los datos,tan solo sincronización temporal, nos da a entender que consiste en una de las mejores ubicaciones para contrastar directamente con la plataforma y además nos intenta demostrar que aproximadamente el centro de masa se encuentra cerca de esa ubicación.


\newpage
\subsection{Principales Desafíos}
\subsubsection{Representación en Tiempo Real}
El principal desafio fue el despliegue en tiempo real de la posicion del COM en la interfaz gráfica del biofeed-back. Se planteó inicialmente en graficar cada una de las salidas tanto del acelerómetro como el giroscopio en donde se representarían 6 variables según la frecuencia de muestreo, lo que en la práctica no es útil. Al representar en gráficos a frecuencias muy altas es decir 100hz o superior, multiplicado por la cantidad de datos que se estén representando, junto con el procesamiento interno para mostrar esos datos, se genera una sobrecarga en la parte gráfica, lo que conlleva a ralentizar el proceso, generando pérdidas de información y fidelidad al desplegar en tiempo real.

Para dar solución al problema, se implementó la opción de graficar un porcentaje de la información recibida en base a la frecuencia de muestreo seleccionada para la captura de información, con esto se asegura que la representación gráfica en tiempo real sea adecuado. Para ello a partir de la frecuencia de muestreo escogida para la prueba se calcula cada cuantas muestras debe ser enviado al gráfico principal, con el fin de no entorpecer la prueba (ver Ecuación \ref{eq:divisorFPS}). 
Luego de realizar el cálculo, a partir del total de muestras se aplica el módulo del $DivisorFPS$, si el resultado es 0 se envía el dato. Es decir, se envían los múltiplos del $DivisorFPS$.

Nota: Si la frecuencia de muestreo es menor a los FPS escogidos se enviarán todas las muestras considerando el resultado de la Ecuación (\ref{eq:divisorFPS}) = 1.

\begin{equation}
\label{eq:divisorFPS}
DivisorFPS=(int)\left(\frac{frecuenciaMuestreo}{FPS}\right)
\end{equation}

A continuación ejemplos del \textit{Divisor FPS} para 100Hz y 200Hz (Tabla \ref{table:divisorFPS100Hz} y Tabla \ref{table:divisorFPS200Hz} respectivamente).

\begin{table}[!htb]
	\begin{minipage}{.5\linewidth}
		\centering
			\begin{tabular}{|c|c|}
				\hline
				\textbf{FPS} & \multicolumn{1}{l|}{\textbf{Divisor FPS}} \\ \hline
				12           & 100 / 12 = 8                                         \\ \hline
				24           & 100 / 24 = 4                                         \\ \hline
				36           & 100 / 36 = 2                                         \\ \hline
				48           & 100 / 48 = 2                                         \\ \hline
				60           & 100 / 60 = 1                                         \\ \hline
			\end{tabular}
			\caption{Divisor FPS Frecuencia 100Hz}
			\label{table:divisorFPS100Hz}
	\end{minipage}%
	\begin{minipage}{.5\linewidth}
		\centering
		\begin{tabular}{|c|c|}
			\hline
			\textbf{FPS} & \multicolumn{1}{l|}{\textbf{Divisor FPS}} \\ \hline
				12           & 200 / 12 = 16                             \\ \hline
				24           & 200 / 24 = 8                              \\ \hline
				36           & 200 / 36 = 5                              \\ \hline
				48           & 200 / 48 = 4                              \\ \hline
				60           & 200 / 60 = 3                              \\ \hline
		\end{tabular}
		\caption{Divisor FPS Frecuencia 200Hz}
		\label{table:divisorFPS200Hz}
	\end{minipage}
\end{table}

\newpage
\subsubsection{Orientación Sensores}
Al momento de realizar la captura de información sensorial, junto con la obtención del ángulo de inclinación deben ser consideradas los siguientes aspectos:
\begin{itemize}
	
	\item \textbf{Referencia ejes del Sensores:} La obtención de información de aceleración y velocidad angular debe estar correctamente alineada con la referencia presente en los ejes del sensor, junto con la posición respecto al eje de gravedad de la tierra, para la correcta obtención de la información en base al movimiento ejercido por los sensores, y que estos sean descritos por los ejes que correspondan, para su posterior análisis o uso.
	
	\item \textbf{Posición en el Sujeto:} Junto con la referencia del sensor, se debe tomar en consideración  la posición que el prototipo fue ubicado en el sujeto de estudio.
\end{itemize}

Para dar solución a este inconveniente se incorporó en el software la opción de describir mediante la interfaz como será puesto el prototipo al momento de realizar las mediciones, usando un indicador de referencia clara, con el fin de no generar problemas para conocer la posición del sensor (ver Figura \ref{fig:referenciaDisp}) y facilitar al usuario final la tarea.
Según la orientación del sensor se generan distintas conjugaciones de los ejes a utilizar tanto para el cálculo del ángulo, como en el uso de la velocidad angular para la aplicación del filtro (en caso de ser utilizado).

\subsubsection{Comunicación Arduino-PC}
\begin{itemize}
	\item \textbf{Data Terminal Ready:} Según el tipo de semiconductor del puerto USB de Arduino puede venir por defecto el Pin DTR (Data Terminal Ready) la función Reset de Arduino puede venir activada o desactivada. 
	La función Reset de Arduino permite al microcontrolador reiniciar las variables internas según las configuraciones encontradas en el Setup del código de programación, para así eliminar cualquier cambio realizado en la ejecución del Loop,lo que es complicación al usar modelos de Arduino que tengan o no esta característica.
	
	Para solucionar este problema se realiza una estandarización activando por Software el Pin DTR para que sin importar el modelo de semiconductor operen todos de forma igual en el software, para así no preocuparse de configuraciones o errores producidos debido al PIN DTR.

	\newpage
	\item \textbf{Latencia en Controlador FTDI:} Por defecto el controlador del puerto USB FTDI para el Sistema Operativo Windows, en su configuración contenía una Latencia de 10 ms pre-configurada, lo que afecta considerablemente la captura de información sobre 100hz. 
	
	El principal inconveniente fue detectarlo, ya que al ser un problema completamente aislado de los elementos que comúnmente son manipulados Arduino y Software, y a su vez es relativo a un modelo concreto de controlador junto a un sistema operativo específico.
	
	La solución a partir de la información para configuración de FTDI\cite{FTDI}. Consistió en modificar directamente el registro de Windows (regedit) en la dirección asociada al controlador(driver) el parámetro de latencia (idealmente 0).
\end{itemize}

\subsubsection{Despliegue de Resultados}
Una de las características del Software es entregar reportes para todas las variables obtenidas, (Desplazamiento, Ángulo, Aceleración y Velocidad Angular, Posición Angular). Esto representa una gran cantidad de información, junto con los gráficos asociados a esta. Un inconveniente inicial al intentar desplegar la información fue que el software tardaba en el desligue entorpeciendo la experiencia de usuario, mientras la información se procesaba.

La solución a este inconveniente fue enviar cada nuevo dato a medida que era leído, esto permitió que al terminar la prueba ya se encontraran disponibles las tablas y gráficos de datos.

\section{Conclusiones y Trabajos Futuros}
\subsection{Conclusiones}
Durante este trabajo de Tesis y partir de los resultados obtenidos, sus posteriores análisis e interpretación de los mismos, se pueden enunciar las siguientes como conclusiones más relevantes.
\begin{itemize}
	\item El principal objetivo de esta Tesis era generar un solución usando Sensor IMU para el estudio del Balance. El principal aporte de este trabajo es demostrar como a partir de sensores inerciales, montados en una placa Arduino y controlados por el Ordenador, es posible replicar con un grado de similitud el estudio del Balance Clínico.
	
	\item Unos de los objetivos era diseñar una solución de bajo coste comparado con el alto precio de los dispositivos actualmente utilizados en el Laboratorio de Bio-mecánica. Si comparamos tan solo en concepto de materiales utilizados para el desarrollo del Dispositivo frente a por ejemplo la Plataforma de Fuerza Kistler, el costo del dispositivo implementado (Arduino+Cable+Sensor+Caja) bordea los 30 mil pesos, frente al valor de la plataforma que cuesta varios millones de pesos.
			
	\item La similitud en la información entregada por nuestra solución respecto de la plataforma es alta, de acuerdo a las pruebas realizadas. Esta Tesis es el punto de partida y/o complementa a las investigaciones y avances en materia de la Biomecánica Humana, donde se hace necesario una adecuada estandarización en el estudio de Balance mediante IMU.
	
	\item Los instrumentos encontrados en el laboratorio de Biomecánica en la Facultad de Salud disponen de softwares con opciones bastantes limitadas. Al desarrollar un software que permite una amplia gama de opciones abre un abanico de posibilidades tanto para estudiantes como investigadores.
	
	\item Todos los sistemas diseñados fueron implementados en C++, lo que garantiza un tiempo de procesado muy corto, junto con una utilización de la máquina bajo en comparación a otros Lenguajes de programación de más alto nivel (Python, Octave), fue probado satisfactoriamente en los equipos del Laboratorio de Biomecánica.
\end{itemize} 

\newpage
\subsection{Trabajos Futuros}
Este trabajo es tan solo una base y puede ser mejorado de las siguientes formas.

\begin{itemize}
	\item Uno de los principales trabajos futuros consiste en la validación de la solución como un instrumento para el estudio del Balance. Además generar diseño de empaquetado de la propuesta para que pueda convertirse en un producto comercializable.
	
	\item La ubicación de dispositivo no era lo más sencillo, pese que existía gran versatilidad, el automatizar la orientación del sensor para facilitar la ubicación del dispositivo, y este se ajuste automáticamente, puede ser mediante la inclusión de sensores con orientación magnética y/o algoritmos con las referencias según la gravedad o inclinación detectada en cada eje.
	
	\item Eliminar la necesidad de utilizar cables, añadir una interfaz de comunicación inalámbrica, junto a una batería para la alimentación, junto con esto podría existir la opción de migrar el Software a plataformas móviles, para la utilización desde Smartphones o Tablets.
	
	\item Mejorar los algoritmos con puestas a puntos más precisas (calibraciones, mejoras, etc) y estudios aun más detallados para asegurar la eficiencia de estos, a su vez mejorar el hardware, sensores para aumentar la precisión en la obtención de información.
	
	\item Arduino es una solución de Microcontroladora de más bajo coste, pero como la tecnología se encuentra siempre en evolución entregando propuestas cada vez más atractivas, considerar desplegar el sistema tanto sensores como el procesamiento y Sofware de análisis en un dispositivo de pequeño tamaño y de bajo coste, listo para conectar y extraer la información, sería de gran valor agregado.
	
\end{itemize}

\section{Bibliografía}
\printbibliography[heading=none]

\end{document}